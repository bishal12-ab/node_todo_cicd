
trigger: none

pool:
  vmImage: ubuntu-latest

stages:
  - stage: codestaticcheck
    displayName: codestati check
    jobs:
      - job: codestaticcheck
        displayName: codestati check
        steps:
          - task: SonarQubePrepare@7
            inputs:
              SonarQube: 'sonar scan'   # ðŸ‘ˆ Service connection ka naam
              scannerMode: 'cli'
              configMode: 'manual'
              cliProjectKey: 'my_applicatina_pipeline_elearn-backend.git_4363d830-02d2-4e94-bae0-f7c0c473d637'
              cliProjectName: 'elearn-backend.git'
              cliSources: '.'

          - task: SonarQubeAnalyze@7
            inputs:
              jdkversion: 'JAVA_HOME_21_X64'
            # ðŸ‘‡ Yeh hata diya â€” yeh problem kar raha tha
            # env:
            #   SONAR_TOKEN: $(SONAR_TOKEN)

          - task: SonarQubePublish@7
            inputs:
              pollingTimeoutSec: '300'
  - stage: buildstage
    displayName: build stage
    jobs:
      - job: buildjob
        displayName: build job
        steps:
        - task: Docker@2
          inputs:
            containerRegistry: 'acr service conection'
            repository: 'elearn-backend'
            command: 'buildAndPush'
            Dockerfile: '**/Dockerfile'
            tags: |
              $(Build.BuildId)
              latest
  - stage: deploystage
    displayName: deploy stage
    jobs:
      - job: deployjob
        displayName: build job
        steps:
        - task: KubernetesManifest@1
          inputs:
            action: 'deploy'
            connectionType: 'kubernetesServiceConnection'
            kubernetesServiceConnection: 'k8s service conection'
            namespace: 'default'
            manifests: 'manifests/*.yaml'
            containers: 'sataksregistry.azurecr.io/elearn-backend.$(Build.BuildId)'
            imagePullSecrets: 'az aks update   --name sati-AKS --resource-group  sat-rg --attach-acr sataksregistry'
